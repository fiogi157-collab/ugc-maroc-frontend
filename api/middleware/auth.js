// =====================================================
// ğŸ” Middleware d'authentification Supabase
// =====================================================

import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY;

const supabase = createClient(supabaseUrl, supabaseServiceKey);

// Middleware pour vÃ©rifier l'authentification
export async function authMiddleware(req, res, next) {
  try {
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        success: false,
        message: "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯"
      });
    }

    const token = authHeader.replace('Bearer ', '');

    // VÃ©rifier le token avec Supabase
    const { data: { user }, error } = await supabase.auth.getUser(token);

    if (error || !user) {
      return res.status(401).json({
        success: false,
        message: "Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©"
      });
    }

    // Ajouter l'utilisateur au request pour utilisation ultÃ©rieure
    req.user = user;
    next();
  } catch (error) {
    console.error("âŒ Auth middleware error:", error);
    return res.status(500).json({
      success: false,
      message: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©"
    });
  }
}

// Middleware pour vÃ©rifier que l'utilisateur est propriÃ©taire de la ressource
export function ownershipMiddleware(userIdField = 'user_id') {
  return (req, res, next) => {
    const resourceUserId = req.body[userIdField] || req.params[userIdField];
    
    if (!resourceUserId) {
      return res.status(400).json({
        success: false,
        message: "Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨"
      });
    }

    if (req.user.id !== resourceUserId) {
      return res.status(403).json({
        success: false,
        message: "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯"
      });
    }

    next();
  };
}
