<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>UGC Maroc - ملفي الشخصي</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: '#7C3AED',
            'background-dark': '#0D0D1A',
            'card-dark': '#1A1A2E',
          },
        },
      },
    };
</script>
<style>
    body { font-family: 'Tajawal', sans-serif; }
    .glow-card { box-shadow: 0 0 15px rgba(124, 58, 237, 0.2); transition: all 0.3s ease; }
    .glow-card:hover { box-shadow: 0 0 25px rgba(124, 58, 237, 0.4); }
    .section-divider { border-top: 2px solid rgba(124, 58, 237, 0.2); margin: 2rem 0; }
    .upload-zone { border: 2px dashed rgba(124, 58, 237, 0.5); transition: all 0.3s ease; }
    .upload-zone:hover { border-color: #7C3AED; background: rgba(124, 58, 237, 0.05); }
    .tag-chip { transition: all 0.2s ease; }
    .tag-chip:hover { transform: translateY(-2px); }
    .toast { animation: slideInRight 0.3s ease; }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    .stat-card { background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(29, 77, 201, 0.1) 100%); }
</style>
</head>
<body class="bg-background-dark text-gray-200">
<script>document.documentElement.classList.add('dark');</script>

<!-- Mobile Header -->
<header class="bg-card-dark p-4 sticky top-0 z-40 border-b border-primary/20">
<div class="flex items-center justify-between">
<a href="/creator/creator_dashboard_1.html" class="p-2 rounded-lg hover:bg-gray-700">
<span class="material-icons">arrow_forward</span>
</a>
<h1 class="text-xl font-bold text-white">ملفي الشخصي</h1>
<button onclick="saveProfile()" class="bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary/90 transition text-sm">
حفظ
</button>
</div>
</header>

<main class="pb-20">
<!-- Profile Header Card -->
<div class="bg-gradient-to-r from-primary/20 to-blue-500/20 p-6">
<div class="flex flex-col items-center text-center">
<div class="relative mb-4">
<img id="profileImage" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCmHi2r7jqzN8GpUovDFPNQnifnDASS3qhnybpZfGQ6TmlC4jHteBAXgKzZxN4HcufNYzNa1alX_cFIIxXGthnhFBLwJNfV0hhFGUknsy1Z1BHEGWAhsYmaxg1zDnT5wwE1y4q_iYxv2VSSn29-KOg73xF0_2yE8urfAdY4N1KGw6pYhgQ2vc5IjVZLbTucd5O-A8kPVkDp-Amt-_b3rz9g5fTr_bRtqo36UOJ7ijd-GQzIKrRDU5DSEgt_7kfwoasqsuXQuGg78FM" alt="Profile" class="w-24 h-24 rounded-full border-4 border-primary"/>
<button onclick="document.getElementById('photoUpload').click()" class="absolute bottom-0 right-0 bg-primary text-white p-2 rounded-full hover:bg-primary/90 transition">
<span class="material-icons text-sm">camera_alt</span>
</button>
<input type="file" id="photoUpload" class="hidden" accept="image/*" onchange="handlePhotoUpload(event)"/>
</div>
<h2 id="displayName" class="text-2xl font-bold text-white mb-1">...</h2>
<p class="text-gray-400 mb-3">منشئ محتوى</p>
<div class="flex gap-2">
<span class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-xs font-semibold flex items-center">
<span class="material-icons text-xs ml-1">verified</span>
موثق
</span>
<span id="displayRating" class="bg-yellow-500/20 text-yellow-400 px-3 py-1 rounded-full text-xs font-semibold">
⭐ --
</span>
</div>
</div>
</div>

<!-- Statistics Grid -->
<div class="grid grid-cols-2 gap-3 p-4">
<div class="stat-card p-4 rounded-lg border border-primary/30">
<div class="flex items-center justify-between mb-2">
<span class="material-icons text-primary">movie</span>
<span id="stat-videos" class="text-2xl font-bold text-white">--</span>
</div>
<p class="text-xs text-gray-400">عدد الفيديوهات</p>
</div>
<div class="stat-card p-4 rounded-lg border border-green-500/30">
<div class="flex items-center justify-between mb-2">
<span class="material-icons text-green-400">check_circle</span>
<span id="stat-acceptance" class="text-2xl font-bold text-white">--</span>
</div>
<p class="text-xs text-gray-400">معدل القبول</p>
</div>
<div class="stat-card p-4 rounded-lg border border-yellow-500/30">
<div class="flex items-center justify-between mb-2">
<span class="material-icons text-yellow-400">star</span>
<span id="stat-rating" class="text-2xl font-bold text-white">--</span>
</div>
<p class="text-xs text-gray-400">التقييم المتوسط</p>
</div>
<div class="stat-card p-4 rounded-lg border border-blue-500/30">
<div class="flex items-center justify-between mb-2">
<span class="material-icons text-blue-400">schedule</span>
<span id="stat-delivery" class="text-2xl font-bold text-white">--</span>
</div>
<p class="text-xs text-gray-400">متوسط التسليم</p>
</div>
</div>

<!-- Personal Information -->
<div class="p-4">
<div class="bg-card-dark rounded-lg p-4 glow-card mb-4">
<h3 class="text-lg font-bold text-white mb-4 flex items-center">
<span class="material-icons text-primary ml-2">person</span>
المعلومات الشخصية
</h3>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-400 mb-2">الاسم الكامل</label>
<input type="text" id="fullName" value="" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-400 mb-2">البريد الإلكتروني</label>
<input type="email" id="email" value="" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-400 mb-2">رقم الهاتف</label>
<input type="tel" id="phone" value="" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-400 mb-2">نبذة عني</label>
<textarea id="bio" rows="4" placeholder="اكتب نبذة قصيرة عنك وخبراتك..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
</div>
</div>
</div>

<!-- Portfolio -->
<div class="bg-card-dark rounded-lg p-4 glow-card mb-4">
<h3 class="text-lg font-bold text-white mb-4 flex items-center">
<span class="material-icons text-primary ml-2">video_library</span>
معرض الأعمال
</h3>
<div id="portfolioGrid" class="grid grid-cols-2 gap-3 mb-4">
<div class="upload-zone rounded-lg p-8 text-center cursor-pointer" onclick="document.getElementById('videoUpload').click()">
<span class="material-icons text-4xl text-primary mb-2 block">add_circle</span>
<p class="text-sm text-gray-400">إضافة فيديو</p>
<input type="file" id="videoUpload" class="hidden" accept="video/*" multiple onchange="handleVideoUpload(event)"/>
</div>
<div class="relative rounded-lg overflow-hidden bg-gray-800 aspect-video">
<video class="w-full h-full object-cover" poster="https://via.placeholder.com/300x200/1A1A2E/7C3AED?text=Video+1">
<source src="#" type="video/mp4"/>
</video>
<button onclick="removeVideo(this)" class="absolute top-2 left-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600">
<span class="material-icons text-sm">close</span>
</button>
</div>
<div class="relative rounded-lg overflow-hidden bg-gray-800 aspect-video">
<video class="w-full h-full object-cover" poster="https://via.placeholder.com/300x200/1A1A2E/7C3AED?text=Video+2">
<source src="#" type="video/mp4"/>
</video>
<button onclick="removeVideo(this)" class="absolute top-2 left-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600">
<span class="material-icons text-sm">close</span>
</button>
</div>
</div>
<p class="text-xs text-gray-500 flex items-center">
<span class="material-icons text-xs ml-1">info</span>
يمكنك إضافة حتى 6 فيديوهات نموذجية
</p>
</div>

<!-- Specializations -->
<div class="bg-card-dark rounded-lg p-4 glow-card mb-4">
<h3 class="text-lg font-bold text-white mb-4 flex items-center">
<span class="material-icons text-primary ml-2">label</span>
التخصصات
</h3>
<div class="flex flex-wrap gap-2 mb-4">
<button onclick="toggleTag(this)" class="tag-chip bg-primary/20 text-primary border border-primary/30 px-4 py-2 rounded-full text-sm font-semibold" data-active="true">
الجمال
</button>
<button onclick="toggleTag(this)" class="tag-chip bg-primary/20 text-primary border border-primary/30 px-4 py-2 rounded-full text-sm font-semibold" data-active="true">
الموضة
</button>
<button onclick="toggleTag(this)" class="tag-chip bg-gray-700 text-gray-400 border border-gray-600 px-4 py-2 rounded-full text-sm font-semibold" data-active="false">
التقنية
</button>
<button onclick="toggleTag(this)" class="tag-chip bg-gray-700 text-gray-400 border border-gray-600 px-4 py-2 rounded-full text-sm font-semibold" data-active="false">
الطعام
</button>
<button onclick="toggleTag(this)" class="tag-chip bg-gray-700 text-gray-400 border border-gray-600 px-4 py-2 rounded-full text-sm font-semibold" data-active="false">
السفر
</button>
<button onclick="toggleTag(this)" class="tag-chip bg-gray-700 text-gray-400 border border-gray-600 px-4 py-2 rounded-full text-sm font-semibold" data-active="false">
الرياضة
</button>
<button onclick="toggleTag(this)" class="tag-chip bg-gray-700 text-gray-400 border border-gray-600 px-4 py-2 rounded-full text-sm font-semibold" data-active="false">
التعليم
</button>
<button onclick="toggleTag(this)" class="tag-chip bg-gray-700 text-gray-400 border border-gray-600 px-4 py-2 rounded-full text-sm font-semibold" data-active="false">
الديكور
</button>
</div>
<p class="text-xs text-gray-500">اختر حتى 5 تخصصات</p>
</div>

<!-- Pricing -->
<div class="bg-card-dark rounded-lg p-4 glow-card mb-4">
<h3 class="text-lg font-bold text-white mb-4 flex items-center">
<span class="material-icons text-primary ml-2">payments</span>
التسعير
</h3>
<div class="space-y-4">
<div class="bg-gray-800 rounded-lg p-4">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center">
<span class="material-icons text-yellow-400 ml-2">schedule</span>
<span class="text-white font-semibold">فيديو 30 ثانية</span>
</div>
<div class="flex items-center">
<input type="number" id="price30s" value="500" class="w-24 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-primary"/>
<span class="text-gray-400 mr-2">د.م</span>
</div>
</div>
</div>
<div class="bg-gray-800 rounded-lg p-4">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center">
<span class="material-icons text-blue-400 ml-2">schedule</span>
<span class="text-white font-semibold">فيديو 60 ثانية</span>
</div>
<div class="flex items-center">
<input type="number" id="price60s" value="800" class="w-24 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-primary"/>
<span class="text-gray-400 mr-2">د.م</span>
</div>
</div>
</div>
<div class="bg-gray-800 rounded-lg p-4">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center">
<span class="material-icons text-green-400 ml-2">schedule</span>
<span class="text-white font-semibold">فيديو 90 ثانية</span>
</div>
<div class="flex items-center">
<input type="number" id="price90s" value="1200" class="w-24 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-primary"/>
<span class="text-gray-400 mr-2">د.م</span>
</div>
</div>
</div>
</div>
<p class="text-xs text-gray-500 mt-3 flex items-center">
<span class="material-icons text-xs ml-1">info</span>
يتم خصم عمولة المنصة 15% من كل عملية
</p>
</div>

<!-- Bank Information -->
<div class="bg-card-dark rounded-lg p-4 glow-card mb-4">
<h3 class="text-lg font-bold text-white mb-4 flex items-center">
<span class="material-icons text-primary ml-2">account_balance</span>
المعلومات البنكية
</h3>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-400 mb-2">اسم صاحب الحساب</label>
<input type="text" id="bankAccountName" value="" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-400 mb-2">اسم البنك</label>
<select id="bankName" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-primary">
<option value="">اختر البنك</option>
<option value="attijariwafa">Attijariwafa Bank</option>
<option value="bmce">BMCE Bank</option>
<option value="bp">Banque Populaire</option>
<option value="cih">CIH Bank</option>
<option value="cdm">Crédit du Maroc</option>
<option value="sgmb">Société Générale</option>
<option value="bmci">BMCI</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-400 mb-2">رقم RIB</label>
<input type="text" id="bankRIB" value="" maxlength="24" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white font-mono focus:outline-none focus:ring-2 focus:ring-primary"/>
</div>
</div>
<div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 mt-4">
<p class="text-xs text-blue-300 flex items-start">
<span class="material-icons text-sm ml-2 mt-0.5">lock</span>
معلوماتك البنكية محمية ومشفرة. يتم استخدامها فقط لتحويل أرباحك.
</p>
</div>
</div>

<!-- Languages -->
<div class="bg-card-dark rounded-lg p-4 glow-card mb-4">
<h3 class="text-lg font-bold text-white mb-4 flex items-center">
<span class="material-icons text-primary ml-2">language</span>
اللغات
</h3>
<div class="space-y-3">
<label class="flex items-center justify-between bg-gray-800 rounded-lg p-4">
<div class="flex items-center">
<span class="text-white font-semibold">العربية</span>
</div>
<input type="checkbox" data-lang="العربية" class="lang-checkbox w-5 h-5 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2"/>
</label>
<label class="flex items-center justify-between bg-gray-800 rounded-lg p-4">
<div class="flex items-center">
<span class="text-white font-semibold">الفرنسية</span>
</div>
<input type="checkbox" data-lang="الفرنسية" class="lang-checkbox w-5 h-5 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2"/>
</label>
<label class="flex items-center justify-between bg-gray-800 rounded-lg p-4">
<div class="flex items-center">
<span class="text-white font-semibold">الدارجة المغربية</span>
</div>
<input type="checkbox" data-lang="الدارجة المغربية" class="lang-checkbox w-5 h-5 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2"/>
</label>
<label class="flex items-center justify-between bg-gray-800 rounded-lg p-4">
<div class="flex items-center">
<span class="text-white font-semibold">الإنجليزية</span>
</div>
<input type="checkbox" data-lang="الإنجليزية" class="lang-checkbox w-5 h-5 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2"/>
</label>
</div>
</div>

<!-- Social Media -->
<div class="bg-card-dark rounded-lg p-4 glow-card mb-4">
<h3 class="text-lg font-bold text-white mb-4 flex items-center">
<span class="material-icons text-primary ml-2">share</span>
الشبكات الاجتماعية
<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full mr-2 font-normal">اختياري</span>
</h3>
<div class="space-y-4">
<div class="flex items-center bg-gray-800 rounded-lg p-4">
<span class="material-icons text-pink-400 ml-3">camera_alt</span>
<input type="text" id="socialInstagram" placeholder="اسم المستخدم في Instagram" class="flex-1 bg-transparent border-none text-white focus:outline-none"/>
</div>
<div class="flex items-center bg-gray-800 rounded-lg p-4">
<span class="material-icons text-blue-400 ml-3">music_note</span>
<input type="text" id="socialTikTok" placeholder="اسم المستخدم في TikTok" class="flex-1 bg-transparent border-none text-white focus:outline-none"/>
</div>
<div class="flex items-center bg-gray-800 rounded-lg p-4">
<span class="material-icons text-red-400 ml-3">play_circle</span>
<input type="text" id="socialYouTube" placeholder="قناة YouTube" class="flex-1 bg-transparent border-none text-white focus:outline-none"/>
</div>
</div>
<p class="text-xs text-gray-500 mt-3 flex items-center">
<span class="material-icons text-xs ml-1">info</span>
ربط حساباتك الاجتماعية يزيد من فرص اختيارك للحملات
</p>
</div>

<!-- Actions -->
<div class="space-y-3 mb-4">
<button onclick="saveProfile()" class="w-full bg-primary text-white px-6 py-4 rounded-lg font-bold hover:bg-primary/90 transition flex items-center justify-center text-lg">
<span class="material-icons ml-3">save</span>
حفظ التغييرات
</button>
<button onclick="previewProfile()" class="w-full bg-gray-700 text-white px-6 py-4 rounded-lg font-bold hover:bg-gray-600 transition flex items-center justify-center">
<span class="material-icons ml-3">visibility</span>
معاينة الملف الشخصي
</button>
</div>

<!-- Danger Zone -->
<div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
<h3 class="text-lg font-bold text-red-400 mb-3 flex items-center">
<span class="material-icons ml-2">warning</span>
منطقة خطرة
</h3>
<button onclick="confirmAccountDeletion()" class="w-full bg-red-500/20 text-red-400 px-6 py-3 rounded-lg font-semibold hover:bg-red-500/30 transition border border-red-500/50">
حذف الحساب نهائياً
</button>
</div>
</div>
</main>

<!-- Bottom Navigation -->
<nav class="fixed bottom-0 left-0 right-0 bg-card-dark border-t border-primary/20 px-4 py-3 z-40">
<div class="flex items-center justify-around">
<a href="/creator/creator_dashboard_1.html" class="flex flex-col items-center text-gray-400 hover:text-primary transition">
<span class="material-icons">dashboard</span>
<span class="text-xs mt-1">الرئيسية</span>
</a>
<a href="/creator/تصفح_الحملات_(للمبدعين).html" class="flex flex-col items-center text-gray-400 hover:text-primary transition">
<span class="material-icons">work_outline</span>
<span class="text-xs mt-1">الحملات</span>
</a>
<a href="/creator/سحب_وتاريخ_الأرباح_(للمبدعين).html" class="flex flex-col items-center text-gray-400 hover:text-primary transition">
<span class="material-icons">account_balance_wallet</span>
<span class="text-xs mt-1">المحفظة</span>
</a>
<a href="/creator/profile.html" class="flex flex-col items-center text-primary transition">
<span class="material-icons">person</span>
<span class="text-xs mt-1">الملف</span>
</a>
</div>
</nav>

<!-- Toast Notification -->
<div id="toast" class="fixed top-6 left-6 hidden toast z-50"></div>

<!-- Supabase Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/config.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/toast.js"></script>
<script src="/js/nav-links.js"></script>

<script>
// =====================================================
// 🔐 VARIABLES GLOBALES
// =====================================================
let currentUser = null;
let creatorData = null;
let portfolioVideos = [];

// =====================================================
// 🔐 AUTH CHECK
// =====================================================
async function checkAuth() {
    try {
        // Attendre que Supabase soit initialisé
        if (!window.supabaseClient) {
            await new Promise((resolve) => {
                window.addEventListener('supabaseReady', resolve, { once: true });
            });
        }

        const { data: { user }, error } = await window.supabaseClient.auth.getUser();
        
        if (error || !user) {
            console.log('❌ Utilisateur non connecté - redirection');
            window.location.href = '/auth/creator-login.html';
            return;
        }

        currentUser = user;
        
        // Vérifier le rôle
        const { data: profile, error: profileError } = await window.supabaseClient
            .from('profiles')
            .select('*')
            .eq('user_id', user.id)
            .single();

        if (profileError || !profile) {
            console.error('❌ Erreur chargement profil:', profileError);
            window.location.href = '/auth/creator-login.html';
            return;
        }

        if (profile.role !== 'creator') {
            console.log('❌ Utilisateur n\'est pas créateur - redirection');
            const redirects = {
                'brand': '/brand/brand_dashboard_premium.html',
                'admin': '/admin/إدارة_المستخدمين_(للمسؤولين)_3.html'
            };
            window.location.href = redirects[profile.role] || '/index.html';
            return;
        }

        console.log('✅ Authentification réussie');
        await loadCreatorData();
    } catch (err) {
        console.error('❌ Erreur auth check:', err);
        window.location.href = '/auth/creator-login.html';
    }
}

// =====================================================
// 📊 CHARGER DONNÉES CRÉATEUR
// =====================================================
async function loadCreatorData() {
    try {
        // 1. Charger profil
        const { data: profile, error: profileError } = await window.supabaseClient
            .from('profiles')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

        if (profileError) throw profileError;

        // 2. Charger données créateur
        const { data: creator, error: creatorError } = await window.supabaseClient
            .from('creators')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

        if (creatorError && creatorError.code !== 'PGRST116') {
            console.error('Erreur chargement creator:', creatorError);
        }

        creatorData = creator;

        // 3. Charger statistiques depuis submissions
        await loadStats();

        // 4. Pré-remplir le formulaire
        fillForm(profile, creator);

    } catch (err) {
        console.error('❌ Erreur chargement données:', err);
        window.toastManager.error('خطأ في تحميل البيانات');
    }
}

// =====================================================
// 📊 CHARGER STATISTIQUES
// =====================================================
async function loadStats() {
    try {
        const { data: submissions, error } = await window.supabaseClient
            .from('submissions')
            .select('*')
            .eq('creator_id', currentUser.id);

        if (error) throw error;

        const totalVideos = submissions ? submissions.length : 0;
        const approvedVideos = submissions ? submissions.filter(s => s.status === 'approved').length : 0;
        const acceptanceRate = totalVideos > 0 ? Math.round((approvedVideos / totalVideos) * 100) : 0;
        
        // Calculer rating moyen
        const ratingsData = submissions ? submissions.filter(s => s.rating).map(s => s.rating) : [];
        const avgRating = ratingsData.length > 0 
            ? (ratingsData.reduce((a, b) => a + b, 0) / ratingsData.length).toFixed(1) 
            : '0.0';

        // Calculer délai moyen (simplifié - en heures)
        const avgDelivery = '48h'; // À calculer depuis les données réelles

        // Afficher
        document.getElementById('stat-videos').textContent = approvedVideos;
        document.getElementById('stat-acceptance').textContent = acceptanceRate + '%';
        document.getElementById('stat-rating').textContent = avgRating;
        document.getElementById('stat-delivery').textContent = avgDelivery;
        document.getElementById('displayRating').textContent = '⭐ ' + avgRating;

    } catch (err) {
        console.error('❌ Erreur chargement stats:', err);
    }
}

// =====================================================
// 📝 PRÉ-REMPLIR FORMULAIRE
// =====================================================
function fillForm(profile, creator) {
    // Informations personnelles
    document.getElementById('fullName').value = profile.full_name || '';
    document.getElementById('email').value = profile.email || '';
    document.getElementById('phone').value = profile.phone || '';
    document.getElementById('bio').value = creator?.bio || profile.bio || '';
    
    document.getElementById('displayName').textContent = profile.full_name || 'Créateur';
    
    // Photo de profil
    if (profile.avatar_url) {
        document.getElementById('profileImage').src = profile.avatar_url;
    }

    // Pricing
    if (creator?.pricing) {
        const pricing = typeof creator.pricing === 'string' ? JSON.parse(creator.pricing) : creator.pricing;
        document.getElementById('price30s').value = pricing['30s'] || 500;
        document.getElementById('price60s').value = pricing['60s'] || 800;
        document.getElementById('price90s').value = pricing['90s'] || 1200;
    }

    // Spécialisations
    if (creator?.specializations) {
        const specializations = Array.isArray(creator.specializations) 
            ? creator.specializations 
            : JSON.parse(creator.specializations || '[]');
        
        document.querySelectorAll('.tag-chip').forEach(tag => {
            const tagText = tag.textContent.trim();
            if (specializations.includes(tagText)) {
                tag.classList.remove('bg-gray-700', 'text-gray-400', 'border-gray-600');
                tag.classList.add('bg-primary/20', 'text-primary', 'border-primary/30');
                tag.dataset.active = 'true';
            }
        });
    }

    // Informations bancaires - Stockées dans le profil
    document.getElementById('bankAccountName').value = profile.full_name || '';
    document.getElementById('bankName').value = '';
    document.getElementById('bankRIB').value = '';

    // Réseaux sociaux - Réinitialiser pour l'instant
    document.getElementById('socialInstagram').value = '';
    document.getElementById('socialTikTok').value = '';
    document.getElementById('socialYouTube').value = '';

    // Langues - Réinitialiser pour l'instant
    document.querySelectorAll('.lang-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    // Portfolio vidéos
    if (creator?.portfolio_videos) {
        portfolioVideos = Array.isArray(creator.portfolio_videos) 
            ? creator.portfolio_videos 
            : JSON.parse(creator.portfolio_videos || '[]');
        renderPortfolioVideos();
    }
}

// =====================================================
// 🎬 RENDER PORTFOLIO VIDEOS
// =====================================================
function renderPortfolioVideos() {
    const grid = document.getElementById('portfolioGrid');
    const uploadButton = grid.querySelector('.upload-zone').parentElement.innerHTML;
    
    let html = uploadButton;
    
    portfolioVideos.forEach((videoUrl, index) => {
        html += `
            <div class="relative rounded-lg overflow-hidden bg-gray-800 aspect-video">
                <video class="w-full h-full object-cover" controls>
                    <source src="${videoUrl}" type="video/mp4"/>
                </video>
                <button onclick="removeVideo(${index})" class="absolute top-2 left-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600">
                    <span class="material-icons text-sm">close</span>
                </button>
            </div>
        `;
    });
    
    grid.innerHTML = html;
}

// =====================================================
// 📸 UPLOAD PHOTO PROFIL
// =====================================================
async function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        window.toastManager.info('📤 جاري رفع الصورة...');

        // Upload vers Supabase Storage
        const uploadResult = await window.utils.uploadFile(file, 'avatars');
        
        if (!uploadResult.success) {
            throw new Error(uploadResult.error);
        }

        // Update profile
        const { error } = await window.supabaseClient
            .from('profiles')
            .update({ avatar_url: uploadResult.url })
            .eq('user_id', currentUser.id);

        if (error) throw error;

        // Afficher preview
        document.getElementById('profileImage').src = uploadResult.url;
        window.toastManager.success('✅ تم تحديث الصورة بنجاح');

    } catch (err) {
        console.error('❌ Erreur upload photo:', err);
        window.toastManager.error('❌ فشل رفع الصورة');
    }
}

// =====================================================
// 🎬 UPLOAD VIDÉOS PORTFOLIO
// =====================================================
async function handleVideoUpload(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    if (portfolioVideos.length + files.length > 6) {
        window.toastManager.warning('⚠️ يمكنك إضافة 6 فيديوهات كحد أقصى');
        return;
    }

    try {
        window.toastManager.info(`📤 جاري رفع ${files.length} فيديو(هات)...`);

        for (const file of files) {
            const uploadResult = await window.utils.uploadFile(file, 'portfolio');
            
            if (uploadResult.success) {
                portfolioVideos.push(uploadResult.url);
            }
        }

        // Update database
        const { error } = await window.supabaseClient
            .from('creators')
            .update({ portfolio_videos: portfolioVideos })
            .eq('user_id', currentUser.id);

        if (error) throw error;

        renderPortfolioVideos();
        window.toastManager.success(`✅ تم إضافة ${files.length} فيديو(هات)`);

        // Reset file input
        event.target.value = '';

    } catch (err) {
        console.error('❌ Erreur upload vidéos:', err);
        window.toastManager.error('❌ فشل رفع الفيديوهات');
    }
}

// =====================================================
// 🗑️ SUPPRIMER VIDÉO
// =====================================================
async function removeVideo(index) {
    if (!confirm('هل تريد حذف هذا الفيديو؟')) return;

    try {
        portfolioVideos.splice(index, 1);

        // Update database
        const { error } = await window.supabaseClient
            .from('creators')
            .update({ portfolio_videos: portfolioVideos })
            .eq('user_id', currentUser.id);

        if (error) throw error;

        renderPortfolioVideos();
        window.toastManager.info('🗑️ تم حذف الفيديو');

    } catch (err) {
        console.error('❌ Erreur suppression vidéo:', err);
        window.toastManager.error('❌ فشل حذف الفيديو');
    }
}

// =====================================================
// 🏷️ TOGGLE TAG SPÉCIALITÉS
// =====================================================
function toggleTag(button) {
    const isActive = button.dataset.active === 'true';
    const activeCount = document.querySelectorAll('.tag-chip[data-active="true"]').length;
    
    if (!isActive && activeCount >= 5) {
        window.toastManager.warning('⚠️ يمكنك اختيار 5 تخصصات كحد أقصى');
        return;
    }
    
    if (isActive) {
        button.classList.remove('bg-primary/20', 'text-primary', 'border-primary/30');
        button.classList.add('bg-gray-700', 'text-gray-400', 'border-gray-600');
        button.dataset.active = 'false';
    } else {
        button.classList.remove('bg-gray-700', 'text-gray-400', 'border-gray-600');
        button.classList.add('bg-primary/20', 'text-primary', 'border-primary/30');
        button.dataset.active = 'true';
    }
}

// =====================================================
// 💾 SAUVEGARDER PROFIL
// =====================================================
async function saveProfile() {
    try {
        window.toastManager.info('💾 جاري حفظ التغييرات...');

        // Récupérer toutes les données du formulaire
        const fullName = document.getElementById('fullName').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const bio = document.getElementById('bio').value;

        // Pricing
        const pricing = {
            '30s': parseInt(document.getElementById('price30s').value),
            '60s': parseInt(document.getElementById('price60s').value),
            '90s': parseInt(document.getElementById('price90s').value)
        };

        // Spécialisations
        const specializations = Array.from(document.querySelectorAll('.tag-chip[data-active="true"]'))
            .map(tag => tag.textContent.trim());

        // Langues
        const languages = Array.from(document.querySelectorAll('.lang-checkbox:checked'))
            .map(cb => cb.dataset.lang);

        // Note: Bank info & social media temporarily not saved (metadata column removed)
        // TODO: Add dedicated columns for this data in future update
        const bankAccountName = document.getElementById('bankAccountName').value;
        const bankName = document.getElementById('bankName').value;
        const rib = document.getElementById('bankRIB').value;
        const socialInstagram = document.getElementById('socialInstagram').value;
        const socialTikTok = document.getElementById('socialTikTok').value;
        const socialYouTube = document.getElementById('socialYouTube').value;

        // Update profiles table (removed metadata reference)
        const { error: profileError } = await window.supabaseClient
            .from('profiles')
            .update({
                full_name: fullName,
                email: email,
                phone: phone,
                bio: bio
            })
            .eq('user_id', currentUser.id);

        if (profileError) throw profileError;

        // Update creators table (upsert si n'existe pas)
        const { error: creatorError } = await window.supabaseClient
            .from('creators')
            .upsert({
                user_id: currentUser.id,
                bio: bio,
                specializations: specializations,
                pricing: pricing,
                portfolio_videos: portfolioVideos
            }, {
                onConflict: 'user_id'
            });

        if (creatorError) throw creatorError;

        window.toastManager.success('✅ تم حفظ التغييرات بنجاح!');
        
        // Recharger les données
        setTimeout(() => {
            loadCreatorData();
        }, 1000);

    } catch (err) {
        console.error('❌ Erreur sauvegarde:', err);
        window.toastManager.error('❌ فشل حفظ التغييرات');
    }
}

// =====================================================
// 👁️ PREVIEW PROFIL
// =====================================================
function previewProfile() {
    window.toastManager.info('👁️ معاينة الملف الشخصي قريباً...');
}

// =====================================================
// ⚠️ SUPPRESSION COMPTE
// =====================================================
function confirmAccountDeletion() {
    if (confirm('⚠️ هل أنت متأكد من حذف حسابك نهائياً؟ لا يمكن التراجع عن هذا الإجراء!')) {
        if (confirm('⛔ تأكيد نهائي: سيتم حذف جميع بياناتك وفيديوهاتك بشكل دائم!')) {
            window.toastManager.error('⛔ ميزة حذف الحساب غير متاحة حالياً. يرجى التواصل مع الدعم.');
        }
    }
}

// Fallback showToast pour compatibilité
function showToast(message, type) {
    if (window.toastManager) {
        window.toastManager.show(message, type);
    }
}

// =====================================================
// 🚀 INITIALISATION
// =====================================================
document.addEventListener('DOMContentLoaded', () => {
    checkAuth();
});

</script>
</body>
</html>
