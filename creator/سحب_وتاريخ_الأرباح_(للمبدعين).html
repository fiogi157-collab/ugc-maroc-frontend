<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سحب وتاريخ الأرباح - UGC Maroc</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5020df',
            'primary-dark': '#3d18a8',
          },
          fontFamily: {
            'cairo': ['Cairo', 'sans-serif'],
          },
        },
      },
    };
  </script>
  
  <style>
    body {
      font-family: 'Cairo', sans-serif;
    }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    [x-cloak] {
      display: none !important;
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .badge {
      @apply px-3 py-1 text-xs font-semibold rounded-full;
    }
    .badge-pending {
      @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200;
    }
    .badge-approved {
      @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200;
    }
    .badge-completed {
      @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200;
    }
    .badge-rejected {
      @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
    }
    .badge-available {
      @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200;
    }
    .badge-withdrawn {
      @apply bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200;
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors" 
      x-data="earningsPage()" 
      x-init="init()"
      x-cloak>

  <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-4">
          <div class="h-10 w-10 text-primary">
            <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z" fill="currentColor"/>
            </svg>
          </div>
          <h1 class="text-xl font-bold text-gray-900 dark:text-white">UGC Maroc</h1>
        </div>
        
        <nav class="hidden md:flex items-center gap-6">
          <a href="/creator/creator_dashboard_1.html" class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary transition">لوحة التحكم</a>
          <a href="/creator/تصفح_الحملات_(للمبدعين).html" class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary transition">الحملات</a>
          <a href="#" class="text-sm font-medium text-primary border-b-2 border-primary">الأرباح</a>
        </nav>

        <div class="flex items-center gap-3">
          <button @click="darkMode = !darkMode" 
                  class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <span class="material-symbols-outlined" x-show="!darkMode">dark_mode</span>
            <span class="material-symbols-outlined" x-show="darkMode">light_mode</span>
          </button>
          <button class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition relative">
            <span class="material-symbols-outlined">notifications</span>
            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
          </button>
          <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
            <span x-text="(userName || 'M').charAt(0).toUpperCase()"></span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div x-show="toast.show" 
       x-transition
       class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 toast">
    <div :class="{
      'bg-green-500': toast.type === 'success',
      'bg-red-500': toast.type === 'error',
      'bg-yellow-500': toast.type === 'warning'
    }" class="px-6 py-3 rounded-lg shadow-lg text-white flex items-center gap-3">
      <span class="material-symbols-outlined">
        <template x-if="toast.type === 'success'">check_circle</template>
        <template x-if="toast.type === 'error'">error</template>
        <template x-if="toast.type === 'warning'">warning</template>
      </span>
      <span x-text="toast.message"></span>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">سحب وتاريخ الأرباح</h1>
      <p class="text-gray-600 dark:text-gray-400">إدارة أرباحك وطلبات السحب بكل شفافية</p>
    </div>

    <template x-if="loading">
      <div class="flex items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
    </template>

    <template x-if="!loading">
      <div class="space-y-8">
        <section>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition">
              <div class="flex items-center justify-between mb-4">
                <span class="text-gray-600 dark:text-gray-400 text-sm font-medium">الرصيد المتاح للسحب</span>
                <span class="material-symbols-outlined text-green-500">account_balance_wallet</span>
              </div>
              <p class="text-3xl font-bold text-green-600 dark:text-green-400" x-text="balance.available + ' درهم'"></p>
              <p class="text-xs text-gray-500 mt-2">يمكنك سحب هذا المبلغ الآن</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition">
              <div class="flex items-center justify-between mb-4">
                <span class="text-gray-600 dark:text-gray-400 text-sm font-medium">إجمالي الأرباح</span>
                <span class="material-symbols-outlined text-blue-500">trending_up</span>
              </div>
              <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="balance.total_earned + ' درهم'"></p>
              <p class="text-xs text-gray-500 mt-2">منذ بداية نشاطك</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition">
              <div class="flex items-center justify-between mb-4">
                <span class="text-gray-600 dark:text-gray-400 text-sm font-medium">سحوبات قيد المعالجة</span>
                <span class="material-symbols-outlined text-yellow-500">hourglass_empty</span>
              </div>
              <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400" x-text="balance.pending + ' درهم'"></p>
              <p class="text-xs text-gray-500 mt-2">في انتظار الموافقة</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition">
              <div class="flex items-center justify-between mb-4">
                <span class="text-gray-600 dark:text-gray-400 text-sm font-medium">إجمالي المسحوب</span>
                <span class="material-symbols-outlined text-purple-500">payments</span>
              </div>
              <p class="text-3xl font-bold text-purple-600 dark:text-purple-400" x-text="totalWithdrawn + ' درهم'"></p>
              <p class="text-xs text-gray-500 mt-2">من جميع السحوبات المكتملة</p>
            </div>
          </div>
        </section>

        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">الأرباح الشهرية</h2>
          <div class="h-64">
            <canvas id="earningsChart"></canvas>
          </div>
        </section>

        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">طلب سحب جديد</h2>
          
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">info</span>
              <div class="flex-1 text-sm text-blue-800 dark:text-blue-200">
                <p class="font-semibold mb-1">ملاحظات هامة:</p>
                <ul class="list-disc list-inside space-y-1">
                  <li>الحد الأدنى للسحب هو 200 درهم</li>
                  <li>يتم خصم عمولة المنصة 15% + رسوم بنكية 17 درهم</li>
                  <li>معالجة الطلبات تستغرق من 2-5 أيام عمل</li>
                </ul>
              </div>
            </div>
          </div>

          <form @submit.prevent="submitWithdrawal" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  المبلغ المطلوب <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <input type="number" 
                         x-model.number="withdrawalForm.amount" 
                         @input="calculateNet"
                         min="200" 
                         :max="parseFloat(balance.available)"
                         step="0.01"
                         required
                         class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                  <span class="absolute left-4 top-3.5 text-gray-500">درهم</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">الحد الأقصى: <span x-text="balance.available"></span> درهم</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  اسم البنك <span class="text-red-500">*</span>
                </label>
                <select x-model="withdrawalForm.bank_name" 
                        required
                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                  <option value="">اختر البنك</option>
                  <option value="Attijariwafa Bank">Attijariwafa Bank</option>
                  <option value="BMCE Bank">BMCE Bank</option>
                  <option value="BMCI">BMCI</option>
                  <option value="Banque Populaire">Banque Populaire</option>
                  <option value="CIH Bank">CIH Bank</option>
                  <option value="Crédit Agricole">Crédit Agricole</option>
                  <option value="Société Générale">Société Générale</option>
                  <option value="CDM">CDM</option>
                  <option value="Al Barid Bank">Al Barid Bank</option>
                  <option value="autre">بنك آخر</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  رقم الحساب البنكي (RIB) <span class="text-red-500">*</span>
                </label>
                <input type="text" 
                       x-model="withdrawalForm.rib" 
                       placeholder="XXXX XXXX XXXX XXXX XXXX XX"
                       maxlength="24"
                       required
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  اسم صاحب الحساب <span class="text-red-500">*</span>
                </label>
                <input type="text" 
                       x-model="withdrawalForm.account_holder" 
                       placeholder="الاسم الكامل كما في البطاقة"
                       required
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border-2 border-dashed border-gray-300 dark:border-gray-600">
              <h3 class="font-semibold text-gray-900 dark:text-white mb-4">ملخص السحب</h3>
              <div class="space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600 dark:text-gray-400">المبلغ المطلوب:</span>
                  <span class="font-semibold" x-text="withdrawalForm.amount.toFixed(2) + ' درهم'"></span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600 dark:text-gray-400">عمولة المنصة (15%):</span>
                  <span class="text-red-600 dark:text-red-400 font-semibold" x-text="'- ' + calculatedFees.platform.toFixed(2) + ' درهم'"></span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600 dark:text-gray-400">رسوم بنكية:</span>
                  <span class="text-red-600 dark:text-red-400 font-semibold">- 17.00 درهم</span>
                </div>
                <div class="border-t border-gray-300 dark:border-gray-600 pt-2 mt-2">
                  <div class="flex justify-between">
                    <span class="font-bold text-gray-900 dark:text-white">المبلغ الصافي المستلم:</span>
                    <span class="font-bold text-green-600 dark:text-green-400 text-lg" x-text="calculatedFees.net.toFixed(2) + ' درهم'"></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex gap-4">
              <button type="submit" 
                      :disabled="submitting || calculatedFees.net <= 0"
                      class="flex-1 bg-primary hover:bg-primary-dark disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition flex items-center justify-center gap-2">
                <span class="material-symbols-outlined" x-show="!submitting">send</span>
                <span class="material-symbols-outlined animate-spin" x-show="submitting">progress_activity</span>
                <span x-text="submitting ? 'جاري الإرسال...' : 'طلب سحب'"></span>
              </button>
              <button type="button" 
                      @click="resetForm"
                      class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                إلغاء
              </button>
            </div>
          </form>
        </section>

        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">تاريخ الأرباح</h2>
          
          <div class="mb-4">
            <div class="relative">
              <span class="absolute right-3 top-3 material-symbols-outlined text-gray-400">search</span>
              <input type="text" 
                     x-model="earningsSearch"
                     placeholder="البحث في الأرباح..."
                     class="w-full pr-10 pl-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">التاريخ</th>
                  <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">الحملة</th>
                  <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">المبلغ الإجمالي</th>
                  <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">العمولة (15%)</th>
                  <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">الصافي</th>
                  <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <template x-for="earning in filteredEarnings" :key="earning.id">
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100" x-text="formatDate(earning.earned_at)"></td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-100" x-text="earning.campaign_title || 'حملة محذوفة'"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-gray-100" x-text="parseFloat(earning.gross_amount).toFixed(2) + ' درهم'"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 dark:text-red-400" x-text="parseFloat(earning.platform_fee).toFixed(2) + ' درهم'"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600 dark:text-green-400" x-text="parseFloat(earning.net_amount).toFixed(2) + ' درهم'"></td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span :class="{
                        'badge-available': earning.status === 'available',
                        'badge-withdrawn': earning.status === 'withdrawn',
                        'badge-pending': earning.status === 'pending'
                      }" class="badge" x-text="getEarningStatusLabel(earning.status)"></span>
                    </td>
                  </tr>
                </template>
                <template x-if="filteredEarnings.length === 0">
                  <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                      <span class="material-symbols-outlined text-5xl mb-2 opacity-50">inbox</span>
                      <p>لا توجد أرباح لعرضها</p>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </section>

        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">طلبات السحب</h2>
          
          <div class="space-y-4">
            <template x-for="withdrawal in withdrawals" :key="withdrawal.id">
              <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-5 hover:shadow-md transition">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <span :class="{
                        'badge-pending': withdrawal.status === 'pending',
                        'badge-approved': withdrawal.status === 'approved',
                        'badge-completed': withdrawal.status === 'completed',
                        'badge-rejected': withdrawal.status === 'rejected'
                      }" class="badge" x-text="getWithdrawalStatusLabel(withdrawal.status)"></span>
                      <span class="text-sm text-gray-500 dark:text-gray-400" x-text="formatDate(withdrawal.requested_at)"></span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                      <div>
                        <p class="text-gray-500 dark:text-gray-400">المبلغ المطلوب</p>
                        <p class="font-semibold text-gray-900 dark:text-white" x-text="parseFloat(withdrawal.amount).toFixed(2) + ' درهم'"></p>
                      </div>
                      <div>
                        <p class="text-gray-500 dark:text-gray-400">الصافي</p>
                        <p class="font-semibold text-green-600 dark:text-green-400" x-text="parseFloat(withdrawal.net_amount).toFixed(2) + ' درهم'"></p>
                      </div>
                      <div>
                        <p class="text-gray-500 dark:text-gray-400">البنك</p>
                        <p class="font-semibold text-gray-900 dark:text-white" x-text="withdrawal.bank_name"></p>
                      </div>
                      <div>
                        <p class="text-gray-500 dark:text-gray-400">صاحب الحساب</p>
                        <p class="font-semibold text-gray-900 dark:text-white" x-text="withdrawal.account_holder"></p>
                      </div>
                    </div>
                    <template x-if="withdrawal.rejection_reason">
                      <div class="mt-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
                        <p class="text-sm text-red-800 dark:text-red-200">
                          <strong>سبب الرفض:</strong> <span x-text="withdrawal.rejection_reason"></span>
                        </p>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="withdrawals.length === 0">
              <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                <span class="material-symbols-outlined text-5xl mb-2 opacity-50">request_quote</span>
                <p>لم تقم بأي طلبات سحب بعد</p>
              </div>
            </template>
          </div>
        </section>
      </div>
    </template>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/config.js"></script>
  <script src="/js/auth.js"></script>
  
  <script>
    function earningsPage() {
      return {
        loading: true,
        darkMode: localStorage.getItem('darkMode') === 'true',
        userName: localStorage.getItem('user_name') || '',
        userId: localStorage.getItem('user_id') || '',
        
        balance: {
          available: '0.00',
          pending: '0.00',
          total_earned: '0.00',
          currency: 'MAD'
        },
        
        earnings: [],
        withdrawals: [],
        earningsSearch: '',
        
        withdrawalForm: {
          amount: 200,
          bank_name: '',
          rib: '',
          account_holder: ''
        },
        
        calculatedFees: {
          platform: 0,
          bank: 17,
          net: 0
        },
        
        submitting: false,
        
        toast: {
          show: false,
          message: '',
          type: 'success'
        },
        
        chart: null,

        async init() {
          if (this.darkMode) {
            document.documentElement.classList.add('dark');
          }

          this.$watch('darkMode', value => {
            if (value) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('darkMode', value);
          });

          await this.waitForSupabase();
          
          const user = await getCurrentUser();
          if (!user) {
            window.location.href = '/auth/creator-login.html';
            return;
          }

          await this.loadData();
          this.calculateNet();
        },

        async waitForSupabase() {
          if (window.supabaseClient) {
            return;
          }
          
          return new Promise((resolve) => {
            const checkSupabase = setInterval(() => {
              if (window.supabaseClient) {
                clearInterval(checkSupabase);
                resolve();
              }
            }, 100);
            
            setTimeout(() => {
              clearInterval(checkSupabase);
              resolve();
            }, 5000);
          });
        },

        async loadData() {
          this.loading = true;
          try {
            await Promise.all([
              this.loadBalance(),
              this.loadEarnings(),
              this.loadWithdrawals()
            ]);
            
            this.$nextTick(() => {
              this.renderChart();
            });
          } catch (error) {
            console.error('Error loading data:', error);
            this.showToast('خطأ في تحميل البيانات', 'error');
          } finally {
            this.loading = false;
          }
        },

        async loadBalance() {
          const token = await this.getAuthToken();
          const response = await fetch(`${window.API_BASE_URL}/api/creator/balance`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          const data = await response.json();
          if (data.success) {
            this.balance = data.balance;
          }
        },

        async loadEarnings() {
          const token = await this.getAuthToken();
          const response = await fetch(`${window.API_BASE_URL}/api/creator/earnings`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          const data = await response.json();
          if (data.success) {
            this.earnings = data.earnings;
          }
        },

        async loadWithdrawals() {
          const token = await this.getAuthToken();
          const response = await fetch(`${window.API_BASE_URL}/api/creator/withdrawals`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          const data = await response.json();
          if (data.success) {
            this.withdrawals = data.withdrawals;
          }
        },

        async getAuthToken() {
          const { data: { session } } = await window.supabaseClient.auth.getSession();
          return session?.access_token;
        },

        calculateNet() {
          const amount = parseFloat(this.withdrawalForm.amount) || 0;
          this.calculatedFees.platform = amount * 0.15;
          this.calculatedFees.net = amount - this.calculatedFees.platform - this.calculatedFees.bank;
        },

        async submitWithdrawal() {
          if (this.calculatedFees.net <= 0) {
            this.showToast('المبلغ غير كافٍ بعد خصم الرسوم', 'error');
            return;
          }

          if (parseFloat(this.withdrawalForm.amount) > parseFloat(this.balance.available)) {
            this.showToast('المبلغ المطلوب أكبر من رصيدك المتاح', 'error');
            return;
          }

          this.submitting = true;
          try {
            const token = await this.getAuthToken();
            const response = await fetch(`${window.API_BASE_URL}/api/creator/withdrawal`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(this.withdrawalForm)
            });

            const data = await response.json();
            
            if (data.success) {
              this.showToast('تم إرسال طلب السحب بنجاح! ⏳', 'success');
              this.resetForm();
              await this.loadData();
            } else {
              this.showToast(data.message || 'فشل إرسال الطلب', 'error');
            }
          } catch (error) {
            console.error('Error submitting withdrawal:', error);
            this.showToast('خطأ في إرسال الطلب', 'error');
          } finally {
            this.submitting = false;
          }
        },

        resetForm() {
          this.withdrawalForm = {
            amount: 200,
            bank_name: '',
            rib: '',
            account_holder: ''
          };
          this.calculateNet();
        },

        renderChart() {
          const ctx = document.getElementById('earningsChart');
          if (!ctx) return;

          const monthlyData = this.getMonthlyEarnings();

          if (this.chart) {
            this.chart.destroy();
          }

          this.chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: monthlyData.labels,
              datasets: [{
                label: 'الأرباح الشهرية (درهم)',
                data: monthlyData.values,
                borderColor: '#5020df',
                backgroundColor: 'rgba(80, 32, 223, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#5020df',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'bottom',
                  labels: {
                    font: {
                      family: 'Cairo',
                      size: 12
                    }
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleFont: {
                    family: 'Cairo',
                    size: 14
                  },
                  bodyFont: {
                    family: 'Cairo',
                    size: 13
                  },
                  padding: 12,
                  displayColors: false,
                  callbacks: {
                    label: function(context) {
                      return context.parsed.y.toFixed(2) + ' درهم';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    font: {
                      family: 'Cairo'
                    },
                    callback: function(value) {
                      return value + ' د.م';
                    }
                  }
                },
                x: {
                  ticks: {
                    font: {
                      family: 'Cairo'
                    }
                  }
                }
              }
            }
          });
        },

        getMonthlyEarnings() {
          const monthlyMap = {};
          const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
          
          this.earnings.forEach(earning => {
            const date = new Date(earning.earned_at);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const monthLabel = `${months[date.getMonth()]} ${date.getFullYear()}`;
            
            if (!monthlyMap[monthKey]) {
              monthlyMap[monthKey] = {
                label: monthLabel,
                total: 0
              };
            }
            monthlyMap[monthKey].total += parseFloat(earning.net_amount);
          });

          const sortedKeys = Object.keys(monthlyMap).sort();
          const last6Months = sortedKeys.slice(-6);

          return {
            labels: last6Months.map(key => monthlyMap[key].label),
            values: last6Months.map(key => monthlyMap[key].total)
          };
        },

        get filteredEarnings() {
          if (!this.earningsSearch) return this.earnings;
          
          const search = this.earningsSearch.toLowerCase();
          return this.earnings.filter(e => 
            (e.campaign_title && e.campaign_title.toLowerCase().includes(search)) ||
            e.gross_amount.toString().includes(search) ||
            e.net_amount.toString().includes(search)
          );
        },

        get totalWithdrawn() {
          return this.withdrawals
            .filter(w => w.status === 'completed')
            .reduce((sum, w) => sum + parseFloat(w.net_amount), 0)
            .toFixed(2);
        },

        formatDate(dateString) {
          if (!dateString) return '-';
          const date = new Date(dateString);
          return date.toLocaleDateString('ar-MA', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        },

        getEarningStatusLabel(status) {
          const labels = {
            'available': 'متاح',
            'withdrawn': 'مسحوب',
            'pending': 'قيد الانتظار'
          };
          return labels[status] || status;
        },

        getWithdrawalStatusLabel(status) {
          const labels = {
            'pending': 'قيد المراجعة',
            'approved': 'موافق عليه',
            'processing': 'قيد المعالجة',
            'completed': 'مكتمل',
            'rejected': 'مرفوض',
            'cancelled': 'ملغي'
          };
          return labels[status] || status;
        },

        showToast(message, type = 'success') {
          this.toast = {
            show: true,
            message,
            type
          };
          setTimeout(() => {
            this.toast.show = false;
          }, 4000);
        }
      };
    }
  </script>
</body>
</html>
