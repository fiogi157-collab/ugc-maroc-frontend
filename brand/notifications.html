<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>UGC Maroc - الإشعارات (علامة تجارية)</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: '#5b13ec',
            'background-dark': '#0D0D1A',
            'card-dark': '#1A1A2E',
          },
        },
      },
    };
</script>
<style>
    body { font-family: 'Cairo', sans-serif; }
    .glow-card { box-shadow: 0 0 15px rgba(124, 58, 237, 0.2); transition: all 0.3s ease; }
    .notification-unread { background: rgba(124, 58, 237, 0.1); border-right: 4px solid #5b13ec; }
    .notification-read { opacity: 0.7; }
    .notification-item { transition: all 0.3s ease; }
    .notification-item:hover { transform: translateX(-5px); }
    .notification-urgent { border-right: 4px solid #ef4444; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .toast { animation: slideInRight 0.3s ease; }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    .badge-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .filter-active { background: rgba(124, 58, 237, 0.2); border-color: #5b13ec; }
</style>
</head>
<body class="bg-background-dark text-gray-200">
<script>document.documentElement.classList.add('dark');</script>

<!-- Mobile Header -->
<header class="bg-card-dark p-4 sticky top-0 z-40 border-b border-primary/20">
<div class="flex items-center justify-between">
<a href="/brand/brand_dashboard_premium.html" class="p-2 rounded-lg hover:bg-gray-700">
<span class="material-icons">arrow_forward</span>
</a>
<div class="flex items-center">
<a href="/index.html" class="text-xl font-bold text-white hover:text-primary transition">الإشعارات</a>
<span id="unreadBadge" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full mr-2 badge-pulse">8</span>
</div>
<button onclick="markAllAsRead()" class="text-primary text-sm font-semibold hover:text-primary/80 transition">
تعيين الكل كمقروء
</button>
</div>
</header>

<main class="pb-20">
<!-- Quick Stats -->
<div class="bg-gradient-to-r from-primary/20 to-blue-500/20 p-4 border-b border-primary/30">
<div class="grid grid-cols-4 gap-2">
<div class="text-center">
<p class="text-2xl font-bold text-white">8</p>
<p class="text-xs text-gray-400">غير مقروءة</p>
</div>
<div class="text-center">
<p class="text-2xl font-bold text-white">15</p>
<p class="text-xs text-gray-400">اليوم</p>
</div>
<div class="text-center">
<p class="text-2xl font-bold text-red-400">2</p>
<p class="text-xs text-gray-400">عاجلة</p>
</div>
<div class="text-center">
<p class="text-2xl font-bold text-white">63</p>
<p class="text-xs text-gray-400">الإجمالي</p>
</div>
</div>
</div>

<!-- Filters -->
<div class="p-4 bg-card-dark border-b border-gray-700">
<div class="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide">
<button onclick="filterNotifications('all')" class="filter-btn filter-active flex-shrink-0 px-4 py-2 rounded-lg border border-gray-600 text-sm font-semibold text-white transition" data-filter="all">
الكل
</button>
<button onclick="filterNotifications('unread')" class="filter-btn flex-shrink-0 px-4 py-2 rounded-lg border border-gray-600 text-sm font-semibold text-gray-300 transition" data-filter="unread">
غير مقروءة
</button>
<button onclick="filterNotifications('submission')" class="filter-btn flex-shrink-0 px-4 py-2 rounded-lg border border-gray-600 text-sm font-semibold text-gray-300 transition" data-filter="submission">
📹 تسليمات
</button>
<button onclick="filterNotifications('campaign')" class="filter-btn flex-shrink-0 px-4 py-2 rounded-lg border border-gray-600 text-sm font-semibold text-gray-300 transition" data-filter="campaign">
🎬 حملات
</button>
<button onclick="filterNotifications('creator')" class="filter-btn flex-shrink-0 px-4 py-2 rounded-lg border border-gray-600 text-sm font-semibold text-gray-300 transition" data-filter="creator">
👤 منشئون
</button>
<button onclick="filterNotifications('urgent')" class="filter-btn flex-shrink-0 px-4 py-2 rounded-lg border border-red-600 text-sm font-semibold text-red-400 transition" data-filter="urgent">
⚠️ عاجل
</button>
</div>
</div>

<!-- Notifications List -->
<div class="p-4 space-y-3" id="notificationsList">
<!-- Low Balance Warning - URGENT UNREAD -->
<div class="notification-item notification-unread notification-urgent bg-card-dark rounded-lg p-4 cursor-pointer" data-read="false" data-type="urgent" data-time="now" onclick="openNotification(this, 1)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center">
<span class="material-icons text-red-400 text-2xl">warning</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">تحذير: رصيد منخفض ⚠️</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">الآن</span>
</div>
<p class="text-sm text-gray-300 mb-2">رصيدك الحالي 450 د.م - قد لا يكفي للحملات النشطة</p>
<div class="flex items-center gap-2">
<button onclick="rechargeBalance(event)" class="text-xs bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition font-semibold">
إعادة الشحن الآن
</button>
<span class="text-xs text-red-400">عاجل</span>
</div>
</div>
</div>
</div>

<!-- New Submission - UNREAD -->
<div class="notification-item notification-unread bg-card-dark rounded-lg p-4 cursor-pointer" data-read="false" data-type="submission" data-time="5m" onclick="openNotification(this, 2)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center">
<span class="material-icons text-blue-400 text-2xl">video_library</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">تسليم فيديو جديد 📹</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ 5 دقائق</span>
</div>
<p class="text-sm text-gray-300 mb-2">سارة أحمد قدمت فيديو لحملة "منتج العناية بالبشرة"</p>
<div class="flex items-center gap-2">
<button onclick="reviewSubmission(event, 2)" class="text-xs bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary/90 transition">
مراجعة الآن
</button>
<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">تسليم</span>
</div>
</div>
</div>
</div>

<!-- Campaign Expiring Soon - URGENT UNREAD -->
<div class="notification-item notification-unread notification-urgent bg-card-dark rounded-lg p-4 cursor-pointer" data-read="false" data-type="urgent" data-time="30m" onclick="openNotification(this, 3)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-orange-500/20 flex items-center justify-center">
<span class="material-icons text-orange-400 text-2xl">schedule</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">حملة توشك على الانتهاء ⏰</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ 30 دقيقة</span>
</div>
<p class="text-sm text-gray-300 mb-2">حملة "إطلاق المنتج الصيفي" تنتهي خلال 24 ساعة - 3 تسليمات معلقة</p>
<div class="flex items-center gap-2">
<button onclick="viewCampaign(event, 3)" class="text-xs bg-orange-500 text-white px-3 py-1 rounded-lg hover:bg-orange-600 transition">
عرض الحملة
</button>
<span class="text-xs text-orange-400">عاجل</span>
</div>
</div>
</div>
</div>

<!-- Creator Accepted Invitation - UNREAD -->
<div class="notification-item notification-unread bg-card-dark rounded-lg p-4 cursor-pointer" data-read="false" data-type="creator" data-time="1h" onclick="openNotification(this, 4)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center">
<span class="material-icons text-green-400 text-2xl">person_add</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">منشئ قبل دعوتك ✅</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ ساعة</span>
</div>
<p class="text-sm text-gray-300 mb-2">أمينة الحسني قبلت دعوتك للعمل على حملة "الموضة الربيعية"</p>
<div class="flex items-center gap-2">
<span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full">منشئ</span>
<button onclick="contactCreator(event, 4)" class="text-xs text-primary hover:underline">إرسال رسالة</button>
</div>
</div>
</div>
</div>

<!-- Multiple Submissions - UNREAD -->
<div class="notification-item notification-unread bg-card-dark rounded-lg p-4 cursor-pointer" data-read="false" data-type="submission" data-time="2h" onclick="openNotification(this, 5)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center">
<span class="material-icons text-blue-400 text-2xl">collections</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">5 تسليمات جديدة 📦</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ ساعتين</span>
</div>
<p class="text-sm text-gray-300 mb-2">لديك 5 فيديوهات جديدة تنتظر المراجعة من حملات مختلفة</p>
<div class="flex items-center gap-2">
<button onclick="reviewAll(event)" class="text-xs bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary/90 transition">
مراجعة الكل
</button>
<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">تسليم</span>
</div>
</div>
</div>
</div>

<!-- Campaign Expired - UNREAD -->
<div class="notification-item notification-unread bg-card-dark rounded-lg p-4 cursor-pointer" data-read="false" data-type="campaign" data-time="3h" onclick="openNotification(this, 6)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-gray-500/20 flex items-center justify-center">
<span class="material-icons text-gray-400 text-2xl">event_busy</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">انتهت حملة 🏁</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ 3 ساعات</span>
</div>
<p class="text-sm text-gray-300 mb-2">حملة "مراجعة منتج تقني" انتهت - تم استلام 12/15 فيديو</p>
<div class="flex items-center gap-2">
<span class="text-xs bg-gray-500/20 text-gray-400 px-2 py-1 rounded-full">حملة</span>
<button onclick="viewCampaignResults(event, 6)" class="text-xs text-primary hover:underline">عرض النتائج</button>
</div>
</div>
</div>
</div>

<!-- Creator Message - UNREAD -->
<div class="notification-item notification-unread bg-card-dark rounded-lg p-4 cursor-pointer" data-read="false" data-type="creator" data-time="4h" onclick="openNotification(this, 7)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center">
<span class="material-icons text-purple-400 text-2xl">chat</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">رسالة من منشئ محتوى 💬</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ 4 ساعات</span>
</div>
<p class="text-sm text-gray-300 mb-2">كريم المالكي: "هل يمكن تمديد الموعد النهائي بيوم واحد؟"</p>
<div class="flex items-center gap-2">
<button onclick="replyMessage(event, 7)" class="text-xs bg-purple-500 text-white px-3 py-1 rounded-lg hover:bg-purple-600 transition">
رد
</button>
<span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded-full">رسالة</span>
</div>
</div>
</div>
</div>

<!-- New Submission - UNREAD -->
<div class="notification-item notification-unread bg-card-dark rounded-lg p-4 cursor-pointer" data-read="false" data-type="submission" data-time="5h" onclick="openNotification(this, 8)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center">
<span class="material-icons text-blue-400 text-2xl">video_library</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">تسليم معاد 🔄</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ 5 ساعات</span>
</div>
<p class="text-sm text-gray-300 mb-2">فاطمة بن علي قدمت نسخة محدثة من الفيديو بعد ملاحظاتك</p>
<div class="flex items-center gap-2">
<button onclick="reviewSubmission(event, 8)" class="text-xs bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary/90 transition">
مراجعة
</button>
<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">تسليم</span>
</div>
</div>
</div>
</div>

<!-- Campaign Statistics - READ -->
<div class="notification-item notification-read bg-card-dark rounded-lg p-4 cursor-pointer" data-read="true" data-type="campaign" data-time="1d" onclick="openNotification(this, 9)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center">
<span class="material-icons text-green-400 text-2xl">trending_up</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">حملتك تحقق نتائج رائعة! 📈</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">البارحة</span>
</div>
<p class="text-sm text-gray-300 mb-2">حملة "مراجعة المنتج" حققت 45,000 مشاهدة و 2,300 تفاعل</p>
<span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full">حملة</span>
</div>
</div>
</div>

<!-- Submission Approved - READ -->
<div class="notification-item notification-read bg-card-dark rounded-lg p-4 cursor-pointer" data-read="true" data-type="submission" data-time="1d" onclick="openNotification(this, 10)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center">
<span class="material-icons text-green-400 text-2xl">check_circle</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">تم الموافقة على 3 فيديوهات</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">البارحة</span>
</div>
<p class="text-sm text-gray-300 mb-2">تمت الموافقة على جميع التسليمات من حملة "الموضة الصيفية"</p>
<span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full">تسليم</span>
</div>
</div>
</div>

<!-- Payment Processed - READ -->
<div class="notification-item notification-read bg-card-dark rounded-lg p-4 cursor-pointer" data-read="true" data-type="payment" data-time="2d" onclick="openNotification(this, 11)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center">
<span class="material-icons text-yellow-400 text-2xl">payments</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">تم معالجة الدفعات 💳</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ يومين</span>
</div>
<p class="text-sm text-gray-300 mb-2">تم دفع 4,500 د.م لـ 6 منشئين من حملاتك</p>
<span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded-full">دفع</span>
</div>
</div>
</div>

<!-- Creator Applied - READ -->
<div class="notification-item notification-read bg-card-dark rounded-lg p-4 cursor-pointer" data-read="true" data-type="creator" data-time="3d" onclick="openNotification(this, 12)">
<div class="flex items-start gap-3">
<div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center">
<span class="material-icons text-blue-400 text-2xl">person</span>
</div>
<div class="flex-1 min-w-0">
<div class="flex items-start justify-between mb-1">
<h3 class="font-bold text-white">منشئون جدد تقدموا لحملتك</h3>
<span class="text-xs text-gray-500 flex-shrink-0 mr-2">منذ 3 أيام</span>
</div>
<p class="text-sm text-gray-300 mb-2">8 منشئين محتوى تقدموا لحملة "إطلاق المنتج الجديد"</p>
<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">منشئ</span>
</div>
</div>
</div>
</div>

<!-- Empty State (Hidden by default) -->
<div id="emptyState" class="hidden p-8 text-center">
<span class="material-icons text-6xl text-gray-600 mb-4 block">notifications_off</span>
<h3 class="text-xl font-bold text-white mb-2">لا توجد إشعارات</h3>
<p class="text-gray-400">ستظهر هنا جميع تحديثات حملاتك وإشعاراتك</p>
</div>
</main>

<!-- Bottom Navigation -->
<nav class="fixed bottom-0 left-0 right-0 bg-card-dark border-t border-primary/20 px-4 py-3 z-40">
<div class="flex items-center justify-around">
<a href="/brand/brand_dashboard_premium.html" class="flex flex-col items-center text-gray-400 hover:text-primary transition">
<span class="material-icons">dashboard</span>
<span class="text-xs mt-1">الرئيسية</span>
</a>
<a href="/brand/تفاصيل_الحملة_(للعلامات_التجارية).html" class="flex flex-col items-center text-gray-400 hover:text-primary transition">
<span class="material-icons">campaign</span>
<span class="text-xs mt-1">حملاتي</span>
</a>
<a href="/brand/notifications.html" class="flex flex-col items-center text-primary transition relative">
<span class="material-icons">notifications</span>
<span class="text-xs mt-1">الإشعارات</span>
<span id="navBadge" class="absolute -top-1 -right-2 w-4 h-4 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center" style="display: none;">0</span>
</a>
<a href="/brand/إعدادات_ملف_العلامة_التجارية_4.html" class="flex flex-col items-center text-gray-400 hover:text-primary transition">
<span class="material-icons">person</span>
<span class="text-xs mt-1">الملف</span>
</a>
</div>
</nav>

<!-- Toast Notification -->
<div id="toast" class="fixed top-6 left-6 hidden toast z-50"></div>

<!-- Supabase Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/config.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/nav-links.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/api.js"></script>

<script>
// ===========================================================
// 🔔 UGC Maroc - Notifications Marque avec Supabase
// ===========================================================

let unreadCount = 0;
let allNotifications = [];

// ===========================================================
// AUTH CHECK - Vérifier que l'utilisateur est une marque
// ===========================================================
async function checkBrandAuth() {
    if (!window.supabaseClient) {
        console.log('⏳ Attente de Supabase...');
        await new Promise(resolve => {
            window.addEventListener('supabaseReady', resolve, { once: true });
        });
    }

    try {
        const { data: { user }, error } = await window.supabaseClient.auth.getUser();

        if (error || !user) {
            console.log('❌ Non connecté, redirection...');
            window.location.href = '/auth/brand-login.html';
            return false;
        }

        const { data: profile } = await window.supabaseClient
            .from('profiles')
            .select('role')
            .eq('user_id', user.id)
            .single();

        if (!profile || profile.role !== 'brand') {
            console.log('❌ Pas une marque, redirection...');
            if (profile?.role === 'creator') {
                window.location.href = '/creator/ugc-creator-dashboard.html';
            } else if (profile?.role === 'admin') {
                window.location.href = '/admin/إدارة_المستخدمين_(للمسؤولين)_3.html';
            } else {
                window.location.href = '/index.html';
            }
            return false;
        }

        console.log('✅ Marque authentifiée');
        return user;
    } catch (err) {
        console.error('Erreur auth:', err);
        window.location.href = '/auth/brand-login.html';
        return false;
    }
}

// ===========================================================
// CHARGER NOTIFICATIONS DEPUIS SUPABASE
// ===========================================================
async function loadNotifications() {
    try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (!user) return;

        const { data: profile } = await window.supabaseClient
            .from('profiles')
            .select('user_id')
            .eq('user_id', user.id)
            .single();

        if (!profile) return;

        allNotifications = [];

        const { data: campaigns } = await window.supabaseClient
            .from('campaigns')
            .select('*')
            .eq('brand_id', profile.user_id)
            .order('created_at', { ascending: false });

        if (campaigns) {
            campaigns.forEach(campaign => {
                const deadline = new Date(campaign.deadline);
                const now = new Date();
                const hoursUntilDeadline = (deadline - now) / (1000 * 60 * 60);

                if (campaign.status === 'active' && hoursUntilDeadline < 48 && hoursUntilDeadline > 0) {
                    allNotifications.push({
                        id: `campaign_${campaign.id}`,
                        type: 'campaign',
                        subtype: 'urgent',
                        title: `حملة توشك على الانتهاء ⏰`,
                        message: `حملة "${campaign.title}" تنتهي خلال ${Math.round(hoursUntilDeadline)} ساعة`,
                        time: new Date(campaign.created_at),
                        read: false,
                        urgent: true,
                        data: campaign
                    });
                }
            });
        }

        const { data: submissions } = await window.supabaseClient
            .from('submissions')
            .select(`
                *,
                campaigns(title, brand_id),
                profiles(full_name)
            `)
            .eq('campaigns.brand_id', profile.user_id)
            .order('submitted_at', { ascending: false })
            .limit(20);

        if (submissions) {
            submissions.forEach(sub => {
                if (sub.campaigns && sub.campaigns.brand_id === profile.user_id) {
                    const isUrgent = sub.status === 'pending' || sub.status === 'under_review';
                    allNotifications.push({
                        id: `submission_${sub.id}`,
                        type: 'submission',
                        title: sub.status === 'pending' ? 'تسليم فيديو جديد 📹' : 
                               sub.status === 'revision_requested' ? 'تسليم معاد 🔄' : 'تسليم',
                        message: `${sub.profiles?.full_name || 'منشئ محتوى'} قدم فيديو لحملة "${sub.campaigns?.title || 'حملة'}"`,
                        time: new Date(sub.submitted_at),
                        read: false,
                        urgent: isUrgent,
                        data: sub
                    });
                }
            });
        }

        const { data: wallet } = await window.supabaseClient
            .from('wallets')
            .select('balance_mad')
            .eq('user_id', profile.user_id)
            .single();

        if (wallet && wallet.balance_mad < 500) {
            allNotifications.push({
                id: 'low_balance',
                type: 'urgent',
                title: 'تحذير: رصيد منخفض ⚠️',
                message: `رصيدك الحالي ${wallet.balance_mad} د.م - قد لا يكفي للحملات النشطة`,
                time: new Date(),
                read: false,
                urgent: true,
                data: wallet
            });
        }

        allNotifications.sort((a, b) => b.time - a.time);
        
        renderNotifications();
        updateStats();
    } catch (err) {
        console.error('Erreur chargement notifications:', err);
        showToast('خطأ في تحميل الإشعارات', 'error');
    }
}

// ===========================================================
// AFFICHER LES NOTIFICATIONS
// ===========================================================
function renderNotifications() {
    const container = document.getElementById('notificationsList');
    if (!container) return;

    if (allNotifications.length === 0) {
        container.innerHTML = `
            <div class="p-8 text-center">
                <span class="material-icons text-6xl text-gray-600 mb-4 block">notifications_off</span>
                <h3 class="text-xl font-bold text-white mb-2">لا توجد إشعارات</h3>
                <p class="text-gray-400">ستظهر هنا جميع تحديثات حملاتك وإشعاراتك</p>
            </div>
        `;
        return;
    }

    container.innerHTML = allNotifications.map(notif => createNotificationHTML(notif)).join('');
}

function createNotificationHTML(notif) {
    const timeAgo = getTimeAgo(notif.time);
    const readClass = notif.read ? 'notification-read' : 'notification-unread';
    const urgentClass = notif.urgent ? 'notification-urgent' : '';
    
    let icon = 'notifications';
    let iconColor = 'blue-500';
    
    if (notif.type === 'submission') {
        icon = 'video_library';
        iconColor = 'blue-500';
    } else if (notif.type === 'campaign') {
        icon = 'schedule';
        iconColor = 'orange-500';
    } else if (notif.type === 'urgent') {
        icon = 'warning';
        iconColor = 'red-500';
    }

    return `
        <div class="notification-item ${readClass} ${urgentClass} bg-card-dark rounded-lg p-4 cursor-pointer" 
             data-read="${notif.read}" 
             data-type="${notif.type}" 
             data-id="${notif.id}"
             onclick="openNotification(this, '${notif.id}')">
            <div class="flex items-start gap-3">
                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-${iconColor}/20 flex items-center justify-center">
                    <span class="material-icons text-${iconColor.replace('500', '400')} text-2xl">${icon}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between mb-1">
                        <h3 class="font-bold text-white">${notif.title}</h3>
                        <span class="text-xs text-gray-500 flex-shrink-0 mr-2">${timeAgo}</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">${notif.message}</p>
                    ${getNotificationActions(notif)}
                </div>
            </div>
        </div>
    `;
}

function getNotificationActions(notif) {
    if (notif.type === 'submission') {
        return `
            <div class="flex items-center gap-2">
                <button onclick="reviewSubmission(event, '${notif.data.id}')" 
                        class="text-xs bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary/90 transition">
                    مراجعة الآن
                </button>
                <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">تسليم</span>
            </div>
        `;
    } else if (notif.type === 'campaign') {
        return `
            <div class="flex items-center gap-2">
                <button onclick="viewCampaign(event, '${notif.data.id}')" 
                        class="text-xs bg-orange-500 text-white px-3 py-1 rounded-lg hover:bg-orange-600 transition">
                    عرض الحملة
                </button>
                <span class="text-xs text-orange-400">عاجل</span>
            </div>
        `;
    } else if (notif.id === 'low_balance') {
        return `
            <div class="flex items-center gap-2">
                <button onclick="rechargeBalance(event)" 
                        class="text-xs bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition font-semibold">
                    إعادة الشحن الآن
                </button>
                <span class="text-xs text-red-400">عاجل</span>
            </div>
        `;
    }
    return '';
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'الآن';
    if (seconds < 3600) return `منذ ${Math.floor(seconds / 60)} دقيقة`;
    if (seconds < 86400) return `منذ ${Math.floor(seconds / 3600)} ساعة`;
    if (seconds < 604800) return `منذ ${Math.floor(seconds / 86400)} يوم`;
    return new Date(date).toLocaleDateString('ar');
}

// ===========================================================
// METTRE À JOUR LES STATISTIQUES
// ===========================================================
function updateStats() {
    const unread = allNotifications.filter(n => !n.read).length;
    const today = allNotifications.filter(n => {
        const now = new Date();
        const notifDate = new Date(n.time);
        return notifDate.toDateString() === now.toDateString();
    }).length;
    const urgent = allNotifications.filter(n => n.urgent).length;
    
    document.querySelector('.grid.grid-cols-4 .text-2xl:nth-of-type(1)').textContent = unread;
    document.querySelector('.grid.grid-cols-4 .text-2xl:nth-of-type(2)').textContent = today;
    document.querySelector('.grid.grid-cols-4 .text-red-400').textContent = urgent;
    document.querySelector('.grid.grid-cols-4 .text-2xl:nth-of-type(4)').textContent = allNotifications.length;
    
    const badge = document.getElementById('unreadBadge');
    if (badge) {
        badge.textContent = unread;
        badge.style.display = unread > 0 ? 'inline-block' : 'none';
    }
    
    const navBadge = document.getElementById('navBadge');
    if (navBadge) {
        navBadge.textContent = unread;
        navBadge.style.display = unread > 0 ? 'flex' : 'none';
    }
    
    unreadCount = unread;
}

// ===========================================================
// FILTRES
// ===========================================================
function filterNotifications(type) {
    const notifications = document.querySelectorAll('.notification-item');
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    filterBtns.forEach(btn => {
        btn.classList.remove('filter-active');
        if (btn.dataset.filter === type) {
            btn.classList.add('filter-active');
        }
    });
    
    notifications.forEach(notification => {
        const notifType = notification.dataset.type;
        const isRead = notification.dataset.read === 'true';
        const isUrgent = notification.classList.contains('notification-urgent');
        
        if (type === 'all') {
            notification.style.display = 'block';
        } else if (type === 'unread') {
            notification.style.display = isRead ? 'none' : 'block';
        } else if (type === 'urgent') {
            notification.style.display = isUrgent ? 'block' : 'none';
        } else {
            notification.style.display = notifType === type ? 'block' : 'none';
        }
    });
    
    checkEmptyState();
}

function checkEmptyState() {
    const visibleNotifications = Array.from(document.querySelectorAll('.notification-item')).filter(n => n.style.display !== 'none');
    const emptyState = document.getElementById('emptyState');
    const notificationsList = document.getElementById('notificationsList');
    
    if (visibleNotifications.length === 0) {
        if (emptyState) emptyState.classList.remove('hidden');
        if (notificationsList) notificationsList.style.display = 'none';
    } else {
        if (emptyState) emptyState.classList.add('hidden');
        if (notificationsList) notificationsList.style.display = 'block';
    }
}

// ===========================================================
// ACTIONS
// ===========================================================
function openNotification(element, id) {
    const notif = allNotifications.find(n => n.id === id);
    if (!notif) return;
    
    if (element.dataset.read === 'false') {
        element.dataset.read = 'true';
        element.classList.remove('notification-unread');
        element.classList.add('notification-read');
        notif.read = true;
        updateStats();
    }
}

function markAllAsRead() {
    const unreadNotifications = document.querySelectorAll('.notification-unread');
    unreadNotifications.forEach(notif => {
        notif.dataset.read = 'true';
        notif.classList.remove('notification-unread');
        notif.classList.add('notification-read');
    });
    
    allNotifications.forEach(n => n.read = true);
    updateStats();
    showToast('✅ تم تعيين جميع الإشعارات كمقروءة', 'success');
}

function rechargeBalance(event) {
    event?.stopPropagation();
    window.location.href = '/brand/Depot_de_Fonds_Marque.html';
}

function reviewSubmission(event, id) {
    event?.stopPropagation();
    window.location.href = `/brand/Valider_Soumissions_Marque.html?submission=${id}`;
}

function viewCampaign(event, id) {
    event?.stopPropagation();
    window.location.href = `/brand/تفاصيل_الحملة_(للعلامات_التجارية).html?id=${id}`;
}

function contactCreator(event, id) {
    event?.stopPropagation();
    showToast('💬 Fonctionnalité messages en développement', 'info');
}

function reviewAll(event) {
    event?.stopPropagation();
    window.location.href = '/brand/Valider_Soumissions_Marque.html';
}

function viewCampaignResults(event, id) {
    event?.stopPropagation();
    window.location.href = `/brand/تفاصيل_الحملة_(للعلامات_التجارية).html?id=${id}`;
}

function replyMessage(event, id) {
    event?.stopPropagation();
    showToast('✉️ Fonctionnalité messages en développement', 'info');
}

function showToast(message, type) {
    const toast = document.getElementById('toast');
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
    };
    toast.className = `fixed top-6 left-6 toast px-6 py-4 rounded-lg font-semibold shadow-lg ${colors[type] || colors.info} text-white z-50`;
    toast.textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

// ===========================================================
// INITIALISATION
// ===========================================================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('🔔 Initialisation notifications marque...');
    
    const user = await checkBrandAuth();
    if (user) {
        await loadNotifications();
    }
});

if (window.supabaseClient) {
    checkBrandAuth().then(user => {
        if (user) loadNotifications();
    });
} else {
    window.addEventListener('supabaseReady', () => {
        checkBrandAuth().then(user => {
            if (user) loadNotifications();
        });
    });
}
</script>

  <!-- Cookie System Integration -->
  <script src="/js/cookie-manager.js"></script>
  <script src="/js/cookie-banner.js"></script>
  <script src="/js/cookie-integration.js"></script>
</body>
</html>