<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>UGC Maroc - تعيين كلمة مرور جديدة</title>

  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#5b13ec",
            "background-light": "#f6f6f8",
            "background-dark": "#161022",
          },
          fontFamily: {
            display: ["Manrope", "sans-serif"],
          },
        },
      },
    };
  </script>

  <style>
    .password-strength {
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 9999px;
      transition: width 0.3s ease-in-out;
    }
    .password-strength-indicator {
      height: 100%;
      border-radius: 9999px;
      transition: width 0.3s ease, background-color 0.3s ease;
    }
    #password-strength.weak .password-strength-indicator {
      width: 33.33%;
      background-color: #ef4444;
    }
    #password-strength.medium .password-strength-indicator {
      width: 66.66%;
      background-color: #f59e0b;
    }
    #password-strength.strong .password-strength-indicator {
      width: 100%;
      background-color: #22c55e;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">

  <main class="flex min-h-screen items-center justify-center p-6">
    <div class="w-full max-w-md rounded-xl bg-white/50 p-8 shadow-md backdrop-blur-sm dark:bg-background-dark/50">
      <div class="text-center mb-6">
        <svg class="mx-auto h-12 w-12 text-primary" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <path d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z" fill="currentColor"></path>
        </svg>
        <h1 class="mt-4 text-2xl font-bold text-gray-900 dark:text-white">تعيين كلمة مرور جديدة</h1>
        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">قم بإدخال كلمة مرور جديدة لتأمين حسابك</p>
      </div>

      <form id="reset-form">
        <div class="space-y-5">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">كلمة المرور الجديدة</label>
            <input 
              id="password" 
              name="password" 
              type="password" 
              required 
              minlength="8"
              placeholder="********" 
              class="block w-full rounded-lg border-gray-300 bg-background-light px-4 py-3 text-gray-900 focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-background-dark dark:text-white" 
            />
            <div id="password-strength" class="password-strength mt-2">
              <div class="password-strength-indicator"></div>
            </div>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">يجب أن تكون كلمة المرور 8 أحرف على الأقل</p>
          </div>

          <div>
            <label for="confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تأكيد كلمة المرور</label>
            <input 
              id="confirm-password" 
              name="confirm-password" 
              type="password" 
              required 
              minlength="8"
              placeholder="********" 
              class="block w-full rounded-lg border-gray-300 bg-background-light px-4 py-3 text-gray-900 focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-background-dark dark:text-white" 
            />
            <p id="password-error" class="hidden mt-2 text-sm text-red-600">كلمتا المرور غير متطابقتين</p>
          </div>

          <!-- Message Container -->
          <div id="message-container" class="hidden"></div>

          <button 
            id="submit-btn"
            type="submit" 
            class="w-full flex justify-center items-center gap-2 rounded-lg bg-primary px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="btn-text">تحديث كلمة المرور</span>
            <span id="btn-loader" class="hidden">
              <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>

          <div class="text-center">
            <a href="/auth/creator-login.html" class="text-sm text-primary hover:underline">العودة إلى تسجيل الدخول</a>
          </div>
        </div>
      </form>
    </div>
  </main>

  <script>
    // Check if user came from forgot-password page with valid token
    const resetToken = sessionStorage.getItem('reset_token');
    
    if (!resetToken) {
      alert('⚠️ جلسة منتهية. يرجى إعادة المحاولة من صفحة نسيت كلمة المرور.');
      window.location.href = '/auth/forgot-password.html';
    }

    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confirm-password");
    const strengthBar = document.getElementById("password-strength");
    const errorText = document.getElementById("password-error");
    const form = document.getElementById("reset-form");
    const submitBtn = document.getElementById("submit-btn");
    const btnText = document.getElementById("btn-text");
    const btnLoader = document.getElementById("btn-loader");
    const messageContainer = document.getElementById("message-container");

    // Password strength indicator
    passwordInput.addEventListener("input", () => {
      const val = passwordInput.value;
      let strength = "weak";
      if (val.length >= 8 && /[A-Z]/.test(val) && /[0-9]/.test(val)) strength = "strong";
      else if (val.length >= 6) strength = "medium";
      strengthBar.className = `password-strength ${strength}`;
    });

    // Password match validation
    confirmPasswordInput.addEventListener("input", () => {
      if (confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value) {
        errorText.classList.remove("hidden");
      } else {
        errorText.classList.add("hidden");
      }
    });

    // Form submission
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      // Validate passwords match
      if (password !== confirmPassword) {
        errorText.classList.remove("hidden");
        confirmPasswordInput.focus();
        return;
      }

      if (password.length < 8) {
        showMessage('error', '⚠️ كلمة المرور يجب أن تكون 8 أحرف على الأقل');
        return;
      }

      setLoading(true);

      try {
        const response = await fetch('/api/auth/reset-password-with-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            verificationToken: resetToken,
            newPassword: password 
          })
        });

        const data = await response.json();

        if (data.success) {
          showMessage('success', '✅ تم تحديث كلمة المرور بنجاح! جاري التحويل...');
          
          // Clear session storage
          sessionStorage.removeItem('reset_token');
          sessionStorage.removeItem('reset_email');

          // Redirect to appropriate login page based on role
          setTimeout(() => {
            const loginUrl = data.role === 'brand' 
              ? '/auth/brand-login.html' 
              : '/auth/creator-login.html';
            window.location.href = loginUrl;
          }, 2000);
        } else {
          showMessage('error', `❌ ${data.error || 'حدث خطأ أثناء تحديث كلمة المرور'}`);
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('error', '❌ حدث خطأ. يرجى المحاولة مرة أخرى.');
      } finally {
        setLoading(false);
      }
    });

    // Show Message
    function showMessage(type, text) {
      const isError = type === 'error';
      messageContainer.className = `mt-4 rounded-lg p-4 border fade-in ${
        isError 
          ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' 
          : 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800'
      }`;
      
      messageContainer.innerHTML = `
        <div class="flex items-center gap-3">
          <svg class="h-6 w-6 ${isError ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${isError 
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
              : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
            }
          </svg>
          <p class="text-sm ${isError ? 'text-red-800 dark:text-red-200' : 'text-green-800 dark:text-green-200'}">
            ${text}
          </p>
        </div>
      `;
      messageContainer.classList.remove('hidden');
    }

    // Set Loading State
    function setLoading(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');
      } else {
        btnText.classList.remove('hidden');
        btnLoader.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
