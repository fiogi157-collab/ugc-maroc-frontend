<!DOCTYPE html>
<html dir="rtl" lang="ar"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>UGC Maroc - استعادة كلمة المرور</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#5b13ec",
        "background-light": "#f6f6f8",
        "background-dark": "#161022",
      },
      fontFamily: {
        display: ["Manrope"],
      },
      borderRadius: {
        DEFAULT: "0.25rem",
        lg: "0.5rem",
        xl: "0.75rem",
        full: "9999px",
      },
    },
  },
};
</script>
<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in {
  animation: fadeIn 0.3s ease-out;
}
</style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">
<div class="flex min-h-screen flex-col items-center justify-center bg-background-light p-4 dark:bg-background-dark">
<div class="w-full max-w-md">
<header class="mb-8 flex flex-col items-center">
<div class="mb-4 text-primary">
<svg class="h-12 w-12" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z" fill="currentColor"></path>
</svg>
</div>
<h1 class="text-2xl font-bold text-gray-900 dark:text-white">
UGC Maroc
</h1>
</header>
<main class="rounded-xl bg-white/50 p-8 shadow-sm ring-1 ring-gray-900/5 backdrop-blur-sm dark:bg-background-dark/50">
<div class="text-center mb-6">
<h2 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
استعادة كلمة المرور
</h2>
<p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
لا تقلق، يحدث ذلك. أدخل بريدك الإلكتروني وسنرسل لك رمز التحقق.
</p>
</div>

<form id="forgot-form">
<div class="space-y-4">
<!-- Email Input -->
<div>
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="email">البريد الإلكتروني</label>
<input 
  autocomplete="email" 
  class="block w-full rounded-lg border-gray-300 bg-background-light px-4 py-3 text-gray-900 placeholder-gray-400 focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-background-dark dark:text-white dark:placeholder-gray-500" 
  id="email" 
  name="email" 
  placeholder="you@example.com" 
  required="" 
  type="email"
/>
</div>

<!-- Code Input (Hidden Initially) -->
<div id="code-container" class="hidden fade-in">
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">رمز التحقق</label>
<input 
  class="block w-full rounded-lg border-gray-300 bg-background-light px-4 py-3 text-gray-900 placeholder-gray-400 focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-background-dark dark:text-white text-center tracking-widest text-lg font-mono" 
  id="code" 
  maxlength="6"
  pattern="[0-9]{6}"
  placeholder="123456" 
  type="text"
/>
<p class="mt-1 text-xs text-gray-500 dark:text-gray-400 text-center">أدخل الرمز المكون من 6 أرقام</p>
</div>

<!-- Message Container -->
<div id="message-container" class="hidden"></div>

<!-- Submit Button -->
<div>
<button 
  id="submit-btn"
  class="flex w-full justify-center items-center gap-2 rounded-lg bg-primary px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:opacity-50 disabled:cursor-not-allowed" 
  type="submit"
>
<span id="btn-text">إرسال رمز التحقق</span>
<span id="btn-loader" class="hidden">
  <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>
</span>
</button>
</div>

<!-- Resend Button (Hidden Initially) -->
<div id="resend-container" class="hidden fade-in text-center">
<button 
  id="resend-btn"
  type="button"
  class="text-sm text-primary hover:text-primary/80 font-medium"
>
إعادة إرسال الرمز
</button>
</div>
</div>
</form>

<div class="mt-6 text-center">
<a class="text-sm font-medium text-primary hover:text-primary/80" href="/auth/creator-login.html">
العودة إلى صفحة تسجيل الدخول
</a>
</div>
</main>
</div>
</div>

<script>
let currentEmail = '';
let codeVerified = false;
let currentState = 'email'; // 'email' | 'code' | 'verified'

const emailInput = document.getElementById('email');
const codeInput = document.getElementById('code');
const codeContainer = document.getElementById('code-container');
const messageContainer = document.getElementById('message-container');
const submitBtn = document.getElementById('submit-btn');
const btnText = document.getElementById('btn-text');
const btnLoader = document.getElementById('btn-loader');
const resendContainer = document.getElementById('resend-container');
const resendBtn = document.getElementById('resend-btn');
const form = document.getElementById('forgot-form');

// Form Submit Handler
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (currentState === 'email') {
    await sendVerificationCode();
  } else if (currentState === 'code') {
    await verifyCode();
  } else if (currentState === 'verified') {
    // Redirect to reset password page
    window.location.href = `/auth/reset-password.html?email=${encodeURIComponent(currentEmail)}`;
  }
});

// Resend Button Handler
resendBtn.addEventListener('click', async () => {
  await sendVerificationCode();
});

// Send Verification Code
async function sendVerificationCode() {
  const email = emailInput.value.trim();
  
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showMessage('error', '⚠️ الرجاء إدخال بريد إلكتروني صحيح');
    return;
  }
  
  currentEmail = email;
  setLoading(true);
  
  try {
    const response = await fetch('/api/auth/send-verification-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showMessage('success', '✅ تم إرسال رمز التحقق إلى بريدك الإلكتروني');
      currentState = 'code';
      codeContainer.classList.remove('hidden');
      resendContainer.classList.remove('hidden');
      emailInput.disabled = true;
      btnText.textContent = 'التحقق من الرمز';
      codeInput.focus();
    } else {
      showMessage('error', `❌ ${data.error || 'حدث خطأ أثناء إرسال الرمز'}`);
    }
  } catch (error) {
    console.error('Error:', error);
    showMessage('error', '❌ حدث خطأ. يرجى المحاولة مرة أخرى.');
  } finally {
    setLoading(false);
  }
}

// Verify Code
async function verifyCode() {
  const code = codeInput.value.trim();
  
  if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
    showMessage('error', '⚠️ الرجاء إدخال رمز مكون من 6 أرقام');
    return;
  }
  
  setLoading(true);
  
  try {
    const response = await fetch('/api/auth/verify-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: currentEmail, code })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Store verification token in sessionStorage for reset-password page
      sessionStorage.setItem('reset_token', data.verificationToken);
      sessionStorage.setItem('reset_email', currentEmail);
      
      showMessage('success', '✅ تم التحقق بنجاح! جاري التحويل...');
      currentState = 'verified';
      
      // Redirect after 1 second
      setTimeout(() => {
        window.location.href = `/auth/reset-password.html`;
      }, 1000);
    } else {
      showMessage('error', `❌ ${data.error || 'الرمز غير صحيح'}`);
      codeInput.value = '';
      codeInput.focus();
    }
  } catch (error) {
    console.error('Error:', error);
    showMessage('error', '❌ حدث خطأ. يرجى المحاولة مرة أخرى.');
  } finally {
    setLoading(false);
  }
}

// Show Message
function showMessage(type, text) {
  const isError = type === 'error';
  messageContainer.className = `mt-4 rounded-lg p-4 border fade-in ${
    isError 
      ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' 
      : 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800'
  }`;
  
  messageContainer.innerHTML = `
    <div class="flex items-center gap-3">
      <svg class="h-6 w-6 ${isError ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        ${isError 
          ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
          : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
        }
      </svg>
      <p class="text-sm ${isError ? 'text-red-800 dark:text-red-200' : 'text-green-800 dark:text-green-200'}">
        ${text}
      </p>
    </div>
  `;
  messageContainer.classList.remove('hidden');
}

// Set Loading State
function setLoading(loading) {
  submitBtn.disabled = loading;
  if (loading) {
    btnText.classList.add('hidden');
    btnLoader.classList.remove('hidden');
  } else {
    btnText.classList.remove('hidden');
    btnLoader.classList.add('hidden');
  }
}
</script>
<script src="/js/nav-links.js"></script>

  <!-- Cookie System Integration -->
  <script src="/js/cookie-manager.js"></script>
  <script src="/js/cookie-banner.js"></script>
  <script src="/js/cookie-integration.js"></script>
</body>
</html>
